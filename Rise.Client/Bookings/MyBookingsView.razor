@page "/mybookings"
@using Rise.Shared.Bookings
@using Rise.Shared.Enums
@using Microsoft.IdentityModel.Tokens
@using Rise.Client.Components.Table
@attribute [Authorize(Roles = "User")]
@inject Microsoft.Extensions.Localization.IStringLocalizer<MyBookingsView> Localizer

<PageTitle>@Localizer["BookingsTitle"]</PageTitle>

<div>
    <GenericTable Headers="Headers" Data="Data(_bookings ?? Array.Empty<BookingDto.ViewBooking>())"  NoDataDisplay="@Localizer["NoBookings"]" IsLoading="_isLoading"/>
</div>

@code {
    [Inject] private IDialogService DialogService { get; set; }
    [Inject] public required IBookingService BookingService { get; set; }
    [Inject] AuthenticationStateProvider AuthenticationStateProvider { get; set; }
    
    
    private IEnumerable<BookingDto.ViewBooking>? _bookings;

    private int _maxBookings;
    private string? userIdAuth0;
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        // Get the current user's authentication state
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        userIdAuth0 = authState.User.Claims.FirstOrDefault(c => c.Type == "sub").Value;
        _bookings = await BookingService.GetAllUserBookings(userIdAuth0) ?? new List<BookingDto.ViewBooking>();
        _isLoading = false;
    }

    private async Task DeleteBooking(string bookingId)
    {
        var result = await DialogService.ShowMessageBox(
            Localizer["CancelBookingTitle"],
            Localizer["CancelBookingMessage"],
            Localizer["CancelBookingYes"],
            Localizer["CancelBookingNo"]
        );

        if (result == true)
        {
            await BookingService.DeleteBookingAsync(bookingId);
            _bookings = await BookingService.GetAllUserBookings(userIdAuth0);
            StateHasChanged();
        }
    }

    private async Task EditBooking(string bookingId)
    {
        var result = await DialogService.ShowMessageBox(
            "Work in progress", "",
            Localizer["CancelBookingYes"]
        );
    }
    
    private List<TableHeader> Headers => new List<TableHeader>
    {
        new (Localizer["Date"]),
        new (Localizer["TimeSlot"]),
        new (Localizer["Status"], "text-center"),
        new (Localizer["Boat"]),
        new (Localizer["Contact"]),
        new (Localizer["Credits"]),
        new ("") // Empty header for action column
    };
    
    private List<List<RenderFragment>> Data(IEnumerable<BookingDto.ViewBooking> bookings)
    {
        var rows = new List<List<RenderFragment>>();

        if (bookings.IsNullOrEmpty())
        {
            return new List<List<RenderFragment>>();
        }
        
        foreach (var booking in bookings)
        {
            var row = new List<RenderFragment>
            {
                TableCellService.DefaultTableCell(booking.bookingDate.ToString("D")),
                TableCellService.DefaultTableCell(Localizer[booking.timeSlot.ToString()]),
                TableCellService.BadgeCell(Localizer[booking.status.ToString()], "badge bg-gradient-" + GetBadgeBackground(booking.status)),
                TableCellService.DefaultTableCell(booking.boat.name),
                TableCellService.UserCell(booking.contact.FirstName, booking.contact.LastName, booking.contact.PhoneNumber),
                TableCellService.DefaultTableCell("Todo"),
                booking.status == BookingStatus.OPEN ? TableCellService.ActionCell(booking.bookingId, this,  EditBooking, DeleteBooking) : TableCellService.DefaultTableCell("")
            };

            rows.Add(row);
        }

        return rows;
    }
    
    
    private string GetBadgeBackground(BookingStatus status) => status switch
    {
        BookingStatus.OPEN => "dark",
        BookingStatus.CLOSED => "secondary",
        BookingStatus.COMPLETED => "success",
        BookingStatus.REFUNDED => "warning",
        BookingStatus.CANCELED => "danger",
        _ => "light"
    };

}
